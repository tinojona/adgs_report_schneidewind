---
title: "4 Data wrangling - Report Exerise"
author: "Tino Schneidewind"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

## Analyzing changes in soil organic matter during elevated CO2 experiments
 
In this report exercise, I will convert a bad example for Open Science data practices into a data set that is usable and consequently allows for a reproducible workflow. Additionally, I will investigate the effect of increased CO2 on soil organic matter.

<br>

The data is taken from *Groenigen, Kees Jan van, Xuan Qi, Craig W. Osenberg, Yiqi Luo, and Bruce A. Hungate. “Faster Decomposition Under Increased Atmospheric CO2 Limits Soil Carbon Storage.” Science 344, no. 6183 (May 2, 2014): 508–9. [https://doi.org/10.1126/science.1249534.](10.1126/science.1249534).* It is saved in the /dataraw folder. Before using it here I cleaned it manually by:

* deleting empty rows,
* deleting the first 3 rows that were empty,
* replacing spaces with "_" in column names, 
* filling the column *Experiments*,
* converting the column depth to a machine readable numeric value,
* converting *Sample dates* to a homogeneous date format

<br>

```{r preamble, message=FALSE, warning=FALSE}
# libraries
library(dplyr); library(lubridate); library(tidyr); library(readr);library(kableExtra)

# clean data
data <- read_csv("../data/groenigen_DBS1.csv", locale = locale(encoding = "UTF-8"))[,1:11]

# convert date column to date class
data <- data |>
  mutate(Sample_date = dmy(Sample_date))
```

<br>

```{r data table, echo=FALSE}
knitr::kable(data[1:10,1:9], 
             col.names = c("Experiment","Citation","Depth","Date","Time","AmbientCO2","IncreasedCO2", "nAmbient", "nIncreased"),
             caption = "Data Overview", 
             align = c("l","l","c","l",rep("c",5))) |>
  kable_styling(bootstrap_options = c("striped"))

```

### 1. Introduction
In the era of climate change, it is vital to understand the effects of increased atmospheric CO2 concentrations on ecosystems. Soil stores carbon in organic and inorganic matter. Organic soil matter is cut-up dead biomass primarily contributed by plants whos growth is regulated by their photosynthesis rate which can be limited or enhanced by the abundance of atmospheric CO2. 

<br>

### 2. Methods
We analyze this effect on the growth influence of plant by comparing two soil samples, one from an environment with ambient CO2 concentrations, the other with increased CO2 concentrations.

We work with data provided by *Groenigen et al. (2014)* who summarized the existing literature on the effect of elevated CO2 concentrations on soil organic matter. We calculate the log-response ratio comparing ambient and elevated soil organic matter across all experiment. However, we will distinguish between different time phases after the start of the experiment. These could indicate a timely development and possibly changes in the reaction of the soil organic matter to the increased CO2 concentration, as well as a possible equilibrium. The phases are:

* early = up to 3 years
* mid = between 3 and 6 years
* late = more than 6 years

The formula used for calculating the log-response ratio RR is:
$$RR = ln( \frac{x_{elevated}}{x_{ambient}} )$$


To get the average log-response ratio for each phase across all experiments we:

1. calculated the averages of ambient and increased for every experiment with respect to the phase,
2. then calculated the log-response ratios of all existing experiment phase pairs
3. and then average over all values of each phase.
 
<br>

```{r RR}
#  aggregate across experiments and phases
data_aggregated <- data |> 
  
  # select columns that we investigate
  select(Experiment, Time_years, mean_ambient_CO2, mean_increased_CO2) |>
  
  # group by experiment
  group_by(Experiment) |>
  
  # 1. summarize across ambient and increased CO2 values in 3 phases
  summarize(mean_ambient_CO2_early = mean(mean_ambient_CO2[Time_years < 3], na.rm = T),                        # early
            mean_ambient_CO2_mid   = mean(mean_ambient_CO2[Time_years >= 3 & Time_years <= 6], na.rm = T),     # mid
            mean_ambient_CO2_late  = mean(mean_ambient_CO2[Time_years > 6], na.rm = T),                        # late
            
            mean_increased_CO2_early = mean(mean_increased_CO2[Time_years < 3], na.rm = T),                    # early
            mean_increased_CO2_mid   = mean(mean_increased_CO2[Time_years >= 3 & Time_years <= 6], na.rm = T), # mid
            mean_increased_CO2_late  = mean(mean_increased_CO2[Time_years > 6], na.rm = T),                    # late
            
            # 2. calculate RR for every parallel observation 
            RR_early = log(mean_increased_CO2_early / mean_ambient_CO2_early),   # early
            RR_mid   = log(mean_increased_CO2_mid / mean_ambient_CO2_mid),       # mid
            RR_late  = log(mean_increased_CO2_late / mean_ambient_CO2_late)      # late
            )

# 3. average the response ratios for every phase
data_RR_means <- data_aggregated |>
  summarize(mean_RR_early = mean(RR_early[!is.nan(RR_early)], na.rm = T),        # early
            mean_RR_mid   = mean(RR_mid[!is.nan(RR_mid)], na.rm = T),            # mid
            mean_RR_late  = mean(RR_late[!is.nan(RR_late)], na.rm = T)           # late
  )
```


<br>

### 3. Results



```{r data aggregated table, echo=FALSE}
knitr::kable(data_aggregated[1:10,],  
             col.names = c("Experiment","ACO2_early","ICO2_early","ACO2_mid","ICO2_mid","ACO2_late","ICO2_late", "RR_early", "RR_mid", "RR_late"), digits = 2, 
             caption = "Aggregated Data")|>
             # align = c("l","l","c","l",rep("c",5))) 
             
  kable_styling(bootstrap_options = c("striped"))

```

NaNs were introduced through the summarizing over phases even though not every phase was represented in every experiment.

<br>


```{r RR table, echo=FALSE}
knitr::kable(data_RR_means,  
             col.names = c("average RR early phase","average RR mid phase","average RR late phase"), digits = 4,
             caption = "Response Ratios to Treatments") 

```



<br>
### 4. Discussion


What are the data that you are looking at?
What do you expect your analysis to show, what is your hypothesis? How should soil organic matter content change under elevated CO?
Interpret your results after aggregating the data: What do your final numbers mean? Do they support your initial hypothesis? Why so, why not?



<br>
### 5. Conclusion


